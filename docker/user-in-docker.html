
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>User · Kubernetes Notes</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Zhiwei Yin">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-image-captions/image-captions.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-local-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="user-and-group.html" />
    
    
    <link rel="prev" href="exec-and-volume.html" />
    

    
        <link rel="shortcut icon" href='../favicon.ico' type="image/x-icon">
    
    
        <link rel="bookmark" href='../favicon.ico' type="image/x-icon">
    
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://zhiweiyin318.github.io/" target="_blank" class="custom-link">My Blog</a>
        </li>
    
        
        <li>
            <a href="https://jimmysong.io/kubernetes-handbook" target="_blank" class="custom-link">Kubernetes-handbook(Jimmysong)</a>
        </li>
    
        
        <li>
            <a href="https://kubernetes.io/" target="_blank" class="custom-link">Kubernetes</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>1.1.</b>
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../content/concept.html">
            
                <a href="../content/concept.html">
            
                    
                        <b>1.2.</b>
                    
                    IaaS PaaS SaaS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../content/kubernetes.html">
            
                <a href="../content/kubernetes.html">
            
                    
                        <b>1.3.</b>
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Docker</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="install.html">
            
                <a href="install.html">
            
                    
                        <b>2.1.</b>
                    
                    Install
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="command.html">
            
                <a href="command.html">
            
                    
                        <b>2.2.</b>
                    
                    Docker Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="cgroups-namepspace.html">
            
                <a href="cgroups-namepspace.html">
            
                    
                        <b>2.3.</b>
                    
                    Namespace && Cgroup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="namespace.html">
            
                <a href="namespace.html">
            
                    
                        <b>2.3.1.</b>
                    
                    Namespace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="exec-and-volume.html">
            
                <a href="exec-and-volume.html">
            
                    
                        <b>2.3.2.</b>
                    
                    Docker exec and Docker volume
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="2.4" data-path="user-in-docker.html">
            
                <a href="user-in-docker.html">
            
                    
                        <b>2.4.</b>
                    
                    User
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.4.1" data-path="user-and-group.html">
            
                <a href="user-and-group.html">
            
                    
                        <b>2.4.1.</b>
                    
                    User and Group
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4.2" data-path="non-root-user.html">
            
                <a href="non-root-user.html">
            
                    
                        <b>2.4.2.</b>
                    
                    Non-root User
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="docker-image.html">
            
                <a href="docker-image.html">
            
                    
                        <b>2.5.</b>
                    
                    Images
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="command.html">
            
                <a href="command.html">
            
                    
                        <b>2.6.</b>
                    
                    Dockerfile
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Kubernetes</li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                        <b>3.1.</b>
                    
                    Install
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../kubernetes/kubeadm-v1.13.0.html">
            
                <a href="../kubernetes/kubeadm-v1.13.0.html">
            
                    
                        <b>3.1.1.</b>
                    
                    Kubeadm Install
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" >
            
                <span>
            
                    
                        <b>3.2.</b>
                    
                    Component
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../kubernetes/kube.html">
            
                <a href="../kubernetes/kube.html">
            
                    
                        <b>3.2.1.</b>
                    
                    kube
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../kubernetes/kubectl.html">
            
                <a href="../kubernetes/kubectl.html">
            
                    
                        <b>3.2.2.</b>
                    
                    Kubectl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="../kubernetes/kube-apiserver.html">
            
                <a href="../kubernetes/kube-apiserver.html">
            
                    
                        <b>3.2.3.</b>
                    
                    Kube-apiserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="../kubernetes/kube-dns.html">
            
                <a href="../kubernetes/kube-dns.html">
            
                    
                        <b>3.2.4.</b>
                    
                    Kube-dns
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" >
            
                <span>
            
                    
                        <b>3.3.</b>
                    
                    Resource
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../kubernetes/pod.html">
            
                <a href="../kubernetes/pod.html">
            
                    
                        <b>3.3.1.</b>
                    
                    Pod
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="../kubernetes/deployment.html">
            
                <a href="../kubernetes/deployment.html">
            
                    
                        <b>3.3.2.</b>
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.3" data-path="../kubernetes/daemonset.html">
            
                <a href="../kubernetes/daemonset.html">
            
                    
                        <b>3.3.3.</b>
                    
                    DaemonSet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.4" data-path="../kubernetes/job-cronJob.html">
            
                <a href="../kubernetes/job-cronJob.html">
            
                    
                        <b>3.3.4.</b>
                    
                    Job CronJob
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../kubernetes/authentication-authorization-admission.html">
            
                <a href="../kubernetes/authentication-authorization-admission.html">
            
                    
                        <b>3.4.</b>
                    
                    Authentication Authorization Admission
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="../kubernetes/tls-ca.html">
            
                <a href="../kubernetes/tls-ca.html">
            
                    
                        <b>3.4.1.</b>
                    
                    TLS CA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.2" data-path="../kubernetes/secret.html">
            
                <a href="../kubernetes/secret.html">
            
                    
                        <b>3.4.2.</b>
                    
                    Secret
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.3" data-path="../kubernetes/service-account.html">
            
                <a href="../kubernetes/service-account.html">
            
                    
                        <b>3.4.3.</b>
                    
                    Service Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.4" data-path="../kubernetes/configmap.html">
            
                <a href="../kubernetes/configmap.html">
            
                    
                        <b>3.4.4.</b>
                    
                    ConfigMap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.5" data-path="../kubernetes/kubernetes-RBAC.html">
            
                <a href="../kubernetes/kubernetes-RBAC.html">
            
                    
                        <b>3.4.5.</b>
                    
                    RBAC
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Operator</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../operator/declarative-api.html">
            
                <a href="../operator/declarative-api.html">
            
                    
                        <b>4.1.</b>
                    
                    Declarative API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../operator/operator.html">
            
                <a href="../operator/operator.html">
            
                    
                        <b>4.2.</b>
                    
                    Operator
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Istio</li>
        
        
    

    
        
        <li class="header">APP</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../app/etcd.html">
            
                <a href="../app/etcd.html">
            
                    
                        <b>6.1.</b>
                    
                    Etcd
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../app/calico.html">
            
                <a href="../app/calico.html">
            
                    
                        <b>6.2.</b>
                    
                    Calico
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../app/helm.html">
            
                <a href="../app/helm.html">
            
                    
                        <b>6.3.</b>
                    
                    Helm
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >User</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="issue">Issue</h1>
<blockquote>
<p>docker run &#x4E00;&#x4E2A;centos&#x955C;&#x50CF;&#xFF0C;&#x5F53;&#x901A;&#x8FC7;non-root&#x7528;&#x6237;exec&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#x540E;&#xFF0C;su&#x5207;&#x6362;&#x5230;root&#x7528;&#x6237;&#x65F6;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;root&#x5BC6;&#x7801;&#x3002;</p>
</blockquote>
<pre><code>yzw@yzw-vm:~$ docker run -it -d centos:7.4.1708 
c091aee509c85153f738815618e6fd8eec20d2795104a687b2f2a5b222161a5f
yzw@yzw-vm:~$ docker exec -it -u 1000 c091aee50 bash
bash-4.2$ id
uid=1000 gid=0(root) groups=0(root)
bash-4.2$ su
Password: 
su: Authentication failure
</code></pre><h1 id="uid-and-gid">UID and GID</h1>
<p>Docker &#x9ED8;&#x8BA4;&#x6CA1;&#x6709;&#x5F00;&#x542F;User Namespace&#xFF0C;Docker&#x548C;Host&#x516C;&#x7528;&#x4E00;&#x5957;UID/GID&#x3002;</p>
<h2 id="example-1">Example 1</h2>
<p>&#x8FD0;&#x884C;&#x4E00;&#x4E2A;centos&#x5BB9;&#x5668;&#xFF1A;</p>
<pre><code>yzw@yzw-vm:~$ docker run -it -d centos:7.4.1708 
c091aee509c85153f738815618e6fd8eec20d2795104a687b2f2a5b222161a5f
</code></pre><p>&#x5728;&#x5BB9;&#x5668;&#x91CC;&#x9762;&#x521B;&#x5EFA;&#x4E2A;test&#x7528;&#x6237;&#xFF0C;UID=1000</p>
<pre><code>yzw@yzw-vm:~$ docker exec -it  c091aee50 bash
[root@c091aee509c8 /]# useradd test
[root@c091aee509c8 /]# cat /etc/passwd | grep test
test:x:1000:1000::/home/test:/bin/bash
</code></pre><p>&#x4F7F;&#x7528;test&#x7528;&#x6237;&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;&#x8DD1;&#x4E2A;sleep</p>
<pre><code>yzw@yzw-vm:~$ docker exec -it -u test c091aee509 bash
[test@c091aee509c8 /]$ sleep 1000
</code></pre><p>&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;root&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;sleep&#x8FDB;&#x7A0B;&#x7684;User&#x662F;test,UID=1000</p>
<pre><code>yzw@yzw-vm:~$ docker exec -it c091aee509 bash
[root@c091aee509c8 /]# ps aux | grep -v grep | grep sleep
test        97  0.0  0.0   4328   716 pts/2    S+   07:30   0:00 sleep 1000
</code></pre><p>host&#x4E3B;&#x673A;&#x4E0A;&#xFF0C;sleep&#x8FDB;&#x7A0B;&#x7684;User&#x662F;yzw&#xFF0C;&#x56E0;&#x4E3A;yzw&#x7684;UID&#x4E5F;&#x662F;1000</p>
<pre><code>yzw@yzw-vm:~$ ps aux | grep -v grep | grep sleep
yzw       4121  0.0  0.0   4328   716 pts/2    S+   15:30   0:00 sleep 1000

yzw@yzw-vm:~$ id
uid=1000(yzw) gid=1000(yzw) groups=1000(yzw),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare),998(docker),999(vboxsf)
</code></pre><h2 id="example-2">Example 2</h2>
<p>&#x5728;&#x5BB9;&#x5668;&#x91CC;&#x9762;&#x521B;&#x5EFA;&#x4E2A;test01&#x7528;&#x6237;&#xFF0C;UID=1001</p>
<pre><code>[root@c091aee509c8 /]# useradd test02
[root@c091aee509c8 /]# cat /etc/passwd | grep test02
test02:x:1001:1001::/home/test02:/bin/bash
[root@c091aee509c8 /]# cat /etc/group | grep test02
test02:x:1001:
</code></pre><p>&#x4F7F;&#x7528;test01&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;&#x8DD1;&#x4E2A;sleep</p>
<pre><code>yzw@yzw-vm:~$ docker exec -it -u test02 c091aee509 bash
[test02@c091aee509c8 /]$ id
uid=1001(test02) gid=1001(test02) groups=1001(test02)
[test02@c091aee509c8 /]$ sleep 1000
</code></pre><p>&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;root&#x8FDB;&#x5165;&#x5BB9;&#x5668;&#xFF0C;sleep&#x8FDB;&#x7A0B;&#x7684;User&#x662F;test02,UID=1001</p>
<pre><code>[root@c091aee509c8 /]# ps aux | grep -v grep | grep sleep
test02     129  0.0  0.0   4328   612 pts/2    S+   01:29   0:00 sleep 1000
</code></pre><p>host&#x4E3B;&#x673A;&#x4E0A;&#xFF0C;sleep&#x8FDB;&#x7A0B;&#x7684;User&#x662F;1001</p>
<pre><code>yzw@yzw-vm:~$ ps aux | grep -v grep | grep sleep
1001   6438  0.0  0.0   4328   612 pts/2    S+   09:29   0:00 sleep 1000
</code></pre><h2 id="example-3">Example 3</h2>
<p>&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7684;UID&#x767B;&#x9646;&#x5BB9;&#x5668;,&#x8DD1;&#x4E2A;sleep&#xFF1A;</p>
<pre><code># &#x53EA;&#x6307;&#x5B9A;&#x4E86;UID&#xFF0C;&#x6240;&#x6709;GID&#x9ED8;&#x8BA4;&#x4E3A;0&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;-u &lt;name|uid&gt;[:&lt;group|gid&gt;]&#x6765;&#x6307;&#x5B9A;GID&#x3002;
yzw@yzw-vm:~$ docker exec -it -u 1003 c091aee509 sh
sh-4.2$ id
uid=1003 gid=0(root) groups=0(root)
sh-4.2$ sleep 1000
</code></pre><p>&#x7528;root&#x767B;&#x9646;&#x5BB9;&#x5668;&#x67E5;&#x770B;&#xFF1A;</p>
<pre><code>[root@c091aee509c8 /]# ps aux | grep -v grep | grep sleep
1003       198  0.0  0.0   4328   660 pts/2    S+   01:48   0:00 sleep 1000
[root@c091aee509c8 /]# 
[root@c091aee509c8 /]# 
[root@c091aee509c8 /]# cat /etc/passwd | grep 1003
[root@c091aee509c8 /]# cat /etc/group | grep 1003
</code></pre><p>Host&#x4E0A;&#x67E5;&#x770B;sleep&#x8FDB;&#x7A0B;&#xFF1A;</p>
<pre><code>yzw@yzw-vm:~$ ps aux | grep -v grep | grep sleep
1003      7399  0.0  0.0   4328   660 pts/2    S+   09:48   0:00 sleep 1000
yzw@yzw-vm:~$ cat /etc/passwd | grep 1003
yzw@yzw-vm:~$ cat /etc/group | grep 1003
</code></pre><h2 id="dockerfile&#x6307;&#x5B9A;&#x7528;&#x6237;">Dockerfile&#x6307;&#x5B9A;&#x7528;&#x6237;</h2>
<pre><code>FROM ubuntu
RUN groupadd -g 999 appuser &amp;&amp; \
    useradd -r -u 999 -g appuser appuser
USER appuser
</code></pre><h1 id="&#x5B89;&#x5168;">&#x5B89;&#x5168;</h1>
<p>&#x5BB9;&#x5668;&#x91CC;&#x9762;&#x548C;&#x4E3B;&#x673A;root&#x7684;&#x6743;&#x9650;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x90A3;&#x5B89;&#x5168;&#x95EE;&#x9898;&#x600E;&#x4E48;&#x89E3;&#x51B3;&#xFF1F;Docker&#x76EE;&#x524D;&#x63D0;&#x4F9B;&#x4E86;2&#x79CD;&#x65B9;&#x6848;&#xFF1A;privileged&#x548C;user namespace&#x3002;</p>
<h2 id="privileged">privileged</h2>
<p>Docker&#x9ED8;&#x8BA4;&#x65F6;&#x5173;&#x95ED;&#x7279;&#x6743;&#x6A21;&#x5F0F;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x7684;&#x65F6;&#x5019;&#x76F4;&#x63A5; <code>docker run --privileged=true</code></p>
<pre><code>$ docker run --help
--privileged                     Give extended privileges to this container
</code></pre><p>&#x8FD9;&#x6837;&#x5168;&#x90E8;&#x7684;capabilities&#x90FD;&#x88AB;&#x8BD5;&#x80FD;&#x3002;</p>
<blockquote>
<p>Full container capabilities (&#x2013;privileged)</p>
<p>The &#x2013;privileged flag gives all capabilities to the container, and it also lifts all the limitations enforced by the device cgroup controller. In other words, the container can then do almost everything that the host can do. This flag exists to allow special use-cases, like running Docker within Docker.</p>
</blockquote>
<p>&#x8FD8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>docker run --cap-add/drop</code> &#x52A0;&#x548C;&#x51CF;&#x6307;&#x5B9A;&#x7684;capabilities</p>
<pre><code>$ docker run --help
--cap-add list                   Add Linux capabilities
--cap-drop list                  Drop Linux capabilities
</code></pre><p>Docker &#x9ED8;&#x8BA4;&#x4E0D;&#x5F00;&#x542F;&#x7279;&#x6743;&#x6A21;&#x5F0F;&#xFF0C;&#x9ED8;&#x8BA4;&#x53EA;&#x652F;&#x6301;&#x4E86;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;capabilities&#xFF0C;&#x4ECE;&#x800C;&#x9650;&#x5236;&#x4E86;&#x5BB9;&#x5668;&#x91CC;&#x9762;root&#x7528;&#x6237;&#x6743;&#x9650;&#x3002;<br>&#x9ED8;&#x8BA4;&#x652F;&#x6301;&#x7684;&#x6709;&#xFF1A;CAP_CHOWN &#x3001; CAP_DAC_OVERRIDE &#x3001; CAP_FSETID &#x3001; CAP_MKNOD &#x3001; FOWNER &#x3001; NET_RAW &#x3001; SETGID &#x3001; SETUID &#x3001; SETFCAP &#x3001; SETPCAP &#x3001; NET_BIND_SERVICE &#x3001; SYS_CHROOT &#x3001; KILL &#x548C; AUDIT_WRITE&#x3002;<br>&#x5728;&#x8FD9; 14 &#x9879;&#x4E2D;&#x51E0;&#x4E4E;&#x6CA1;&#x6709;&#x4E00;&#x9879;&#x6D89;&#x53CA;&#x5230;&#x7CFB;&#x7EDF;&#x7BA1;&#x7406;&#x6743;&#x9650;&#xFF0C;&#x6BD4;&#x5982; Docker &#x5BB9;&#x5668;&#x7684; root &#x7528;&#x6237;&#x4E0D;&#x5177;&#x5907; CAP_SYS_ADMIN&#xFF0C;&#x78C1;&#x76D8;&#x9650;&#x989D;&#x64CD;&#x4F5C;&#x3001;mount &#x64CD;&#x4F5C;&#x3001;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x65B0;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x7B49;&#x5747;&#x65E0;&#x6CD5;&#x5B9E;&#x73B0;&#xFF1B;&#x6BD4;&#x5982;&#x7531;&#x4E8E;&#x6CA1;&#x6709; CAP_NET_ADMIN&#xFF0C;&#x7F51;&#x7EDC;&#x65B9;&#x9762;&#x7684;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x4E5F;&#x5C06;&#x53D7;&#x5230;&#x7BA1;&#x5236;&#x3002;</p>
<ul>
<li>CAP<em>SYS_ADMIN&#xFF1A;CAP_SYS_ADMIN  &#x5B9E;&#x73B0;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x7CFB;&#x7EDF;&#x7BA1;&#x7406;&#x6743;&#x9650;&#xFF0C;&#x6BD4;&#x5982;&#x5B9E;&#x73B0;&#x78C1;&#x76D8;&#x914D;&#x989D;&#x7684; quotactl&#xFF0C;&#x5B9E;&#x73B0;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6302;&#x8F7D;&#x7684; mount &#x6743;&#x9650;&#xFF1B;&#x6BD4;&#x5982;&#x5728; fork &#x5B50;&#x8FDB;&#x7A0B;&#x65F6;&#xFF0C;&#x901A;&#x8FC7; clone &#x548C; unshare &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x4F7F;&#x7528; CLONE</em>* &#x7684; flag  &#x53C2;&#x6570;&#x6765;&#x4E3A;&#x5B50;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x65B0;&#x7684; namespaces&#xFF1B;&#x6BD4;&#x5982;&#x5B9E;&#x73B0;&#x5404;&#x79CD;&#x7279;&#x6743;&#x5757;&#x8BBE;&#x5907;&#x4EE5;&#x53CA;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684; ioctl &#x64CD;&#x4F5C;&#x7B49;&#x3002;</li>
<li>CAP_NET_ADMIN&#xFF1A;CAP_NET_ADMIN  &#x5B9E;&#x73B0;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x7F51;&#x7EDC;&#x7BA1;&#x7406;&#x6743;&#x9650;&#xFF0C;&#x6BD4;&#x5982;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x7684;&#x914D;&#x7F6E;&#xFF0C;IP &#x9632;&#x706B;&#x5899;&#xFF0C;IP &#x4F2A;&#x88C5;&#x4EE5;&#x53CA;&#x7EDF;&#x8BA1;&#x7B49;&#x529F;&#x80FD;&#xFF1B;&#x6BD4;&#x5982;&#x8DEF;&#x7531;&#x8868;&#x7684;&#x4FEE;&#x6539;&#xFF0C;TOS &#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x6DF7;&#x6742;&#x6A21;&#x5F0F;&#x7684;&#x914D;&#x7F6E;&#x7B49;&#x3002;</li>
<li>CAP_SETUID&#xFF1A;CAP_SETUID  &#x6709;&#x80FD;&#x529B;&#x5BF9;&#x8FDB;&#x7A0B; UID &#x505A;&#x51FA;&#x4EFB;&#x4F55;&#x7BA1;&#x63A7;&#x3002;</li>
<li>CAP_SYS_MODULE&#xFF1A;CAP_SYS_MODULE  &#x5E2E;&#x52A9; root &#x7528;&#x6237;&#x52A0;&#x8F7D;&#x6216;&#x8005;&#x5378;&#x8F7D;&#x76F8;&#x5E94;&#x7684; Linux &#x5185;&#x6838;&#x6A21;&#x5757;&#x3002;</li>
<li>CAP_SYS_NICE&#xFF1A;CAP_SYS_NICE  &#x6709;&#x80FD;&#x529B;&#x5BF9;&#x4EFB;&#x610F;&#x8FDB;&#x7A0B;&#x4FEE;&#x6539;&#x5176; NICE &#x503C;&#xFF0C;&#x540C;&#x65F6;&#x652F;&#x6301;&#x5BF9;&#x4EFB;&#x4F55;&#x8FDB;&#x7A0B;&#x8BBE;&#x7F6E;&#x8C03;&#x5EA6;&#x7B56;&#x7565;&#x4E0E;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x8FD8;&#x6709;&#x5728;&#x8FDB;&#x7A0B;&#x7684; CPU &#x4EB2;&#x548C;&#x6027;&#x4EE5;&#x53CA; I/O &#x8C03;&#x5EA6;&#x65B9;&#x9762;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x914D;&#x7F6E;&#x6743;&#x9650;</li>
</ul>
<h2 id="user-namespace">User Namespace</h2>
<p>&#x5F00;&#x542F;&#xFF1A;</p>
<pre><code># /etc/docker/daemon.json
{
  &quot;userns-remap&quot;: &quot;default&quot;
}

$ systemctl restart docker
</code></pre><p>&#x9A8C;&#x8BC1;</p>
<pre><code># &#x5F00;&#x542F;&#x540E;&#x7CFB;&#x7EDF;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;dockremap&#x7684;&#x7528;&#x6237;
yzw@yzw-vm:~/code/ns$ id dockremap
uid=125(dockremap) gid=130(dockremap) groups=130(dockremap)
yzw@yzw-vm:~/code/ns$ sudo cat /etc/group | grep dockre
dockremap:x:130:
yzw@yzw-vm:~/code/ns$ sudo cat /etc/passwd | grep dockre
dockremap:x:125:130::/home/dockremap:/bin/false
# &#x65B0;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;165536.165536,165536&#x662F;dockremap&#x6620;&#x5C04;&#x51FA;&#x6765;&#x7684;&#x4E00;&#x4E2A;uid
yzw@yzw-vm:~/code/ns$ sudo ls -ld  /var/lib/docker/165536.165536 
drwx------ 14 165536 165536 4096 Dec 29 00:39 /var/lib/docker/165536.165536
# &#x8BE5;&#x76EE;&#x5F55;&#x548C;/var/lib/docker&#x76EE;&#x5F55;&#x57FA;&#x672C;&#x4E00;&#x6837;&#xFF0C;&#x7528;&#x6237;&#x9694;&#x79BB;&#x7684;&#x6587;&#x4EF6;&#x90FD;&#x653E;&#x8FD9;
yzw@yzw-vm:~/code/ns$ sudo ls -l  /var/lib/docker/165536.165536 
total 48
drwx------ 2 root   root   4096 Dec 29 00:39 builder
drwx------ 4 root   root   4096 Dec 29 00:39 buildkit
drwx------ 2 165536 165536 4096 Dec 29 00:39 containers
drwx------ 3 root   root   4096 Dec 29 00:39 image
drwxr-x--- 3 root   root   4096 Dec 29 00:39 network
drwx------ 3 165536 165536 4096 Dec 29 00:39 overlay2
drwx------ 4 root   root   4096 Dec 29 00:39 plugins
drwx------ 2 root   root   4096 Dec 29 00:39 runtimes
drwx------ 2 root   root   4096 Dec 29 00:39 swarm
drwx------ 2 165536 165536 4096 Dec 29 00:39 tmp
drwx------ 2 root   root   4096 Dec 29 00:39 trust
drwx------ 2 165536 165536 4096 Dec 29 00:39 volumes
</code></pre><p>&#x4F7F;&#x7528;</p>
<pre><code># &#x62C9;&#x4E2A;&#x5BB9;&#x5668;&#x8DD1;&#x4E2A;sleep
yzw@yzw-vm:~/code/ns$ docker run -it -d centos bash
5028c0844804f6e5a5d57840448edeb596fa73a7d82d74eb40246ce9fc200e21
yzw@yzw-vm:~/code/ns$ docker exec -it 5028c084 bash
[root@5028c0844804 /]# id
uid=0(root) gid=0(root) groups=0(root)
[root@5028c0844804 /]# sleep 1000

# host&#x4E0A;&#xFF0C;sleep&#x7684;uid&#x662F;165536&#xFF0C;uid 165536 &#x662F;&#x7528;&#x6237; dockremap &#x7684;&#x4E00;&#x4E2A;&#x4ECE;&#x5C5E; ID&#xFF0C;&#x5728;&#x5BBF;&#x4E3B;&#x673A;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x6B8A;&#x6743;&#x9650;&#x3002;&#x7136;&#x800C;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7528;&#x6237;&#x5374;&#x662F; root&#xFF0C;
yzw@yzw-vm:~$ ps aux | grep sleep
165536    5249  0.0  0.0   4372   660 pts/1    S+   00:53   0:00 sleep 1000

# &#x542F;&#x52A8;&#x67D0;&#x4E2A;&#x5BB9;&#x5668;&#x4E0D;&#x4F7F;&#x7528;user namespace&#xFF0C;&#x52A0;--userns=host
$ docker run -d --userns=host --name sleepme ubuntu sleep infinity
</code></pre><p>&#x95EE;&#x9898;&#xFF1A;
&#x76EE;&#x524D; docker &#x5BF9;&#x5B83;&#x7684;&#x652F;&#x6301;&#x8FD8;&#x7B97;&#x4E0D;&#x4E0A;&#x5B8C;&#x7F8E;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x5DF2;&#x77E5;&#x7684;&#x51E0;&#x4E2A;&#x548C;&#x73B0;&#x6709;&#x529F;&#x80FD;&#x4E0D;&#x517C;&#x5BB9;&#x7684;&#x95EE;&#x9898;&#xFF1A;</p>
<ul>
<li>&#x5171;&#x4EAB;&#x4E3B;&#x673A;&#x7684; PID &#x6216; NET namespace(--pid=host or --network=host)   </li>
<li>&#x5916;&#x90E8;&#x7684;&#x5B58;&#x50A8;&#x3001;&#x6570;&#x636E;&#x5377;&#x9A71;&#x52A8;&#x53EF;&#x80FD;&#x4E0D;&#x517C;&#x5BB9;&#x3001;&#x4E0D;&#x652F;&#x6301; user namespace</li>
<li>&#x4F7F;&#x7528; --privileged &#x800C;&#x4E0D;&#x6307;&#x5B9A; --userns=host</li>
</ul>
<blockquote>
<p>Reference:<br><a href="https://success.docker.com/article/introduction-to-user-namespaces-in-docker-engine" target="_blank">https://success.docker.com/article/introduction-to-user-namespaces-in-docker-engine</a><br><a href="https://docs.docker.com/engine/security/userns-remap/" target="_blank">https://docs.docker.com/engine/security/userns-remap/</a>
<a href="https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf" target="_blank">https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf</a></p>
</blockquote>
<h1 id="qa">QA</h1>
<h3 id="&#x5BB9;&#x5668;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#x8BC6;&#x522B;&#x5230;host&#x7684;&#x6240;&#x6709;&#x7528;&#x6237;">&#x5BB9;&#x5668;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#x8BC6;&#x522B;&#x5230;host&#x7684;&#x6240;&#x6709;&#x7528;&#x6237;</h3>
<p>&#x56E0;&#x4E3A;/etc&#x76EE;&#x5F55;&#x4E0D;&#x662F;host&#x7684;</p>
<h3 id="&#x5BB9;&#x5668;exec&#x8FDB;&#x53BB;&#x4E3A;&#x4EC0;&#x4E48;&#x9ED8;&#x8BA4;&#x662F;root&#x7528;&#x6237;">&#x5BB9;&#x5668;exec&#x8FDB;&#x53BB;&#x4E3A;&#x4EC0;&#x4E48;&#x9ED8;&#x8BA4;&#x662F;root&#x7528;&#x6237;</h3>
<p>dockerfile&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x53EF;&#x4EE5;&#x4FEE;&#x6539; </p>
<footer class="page-footer"><span class="copyright">powered by Gitbook</span><span class="footer-modification">Updated:
2019-01-18 14:43:26
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="exec-and-volume.html" class="navigation navigation-prev " aria-label="Previous page: Docker exec and Docker volume">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="user-and-group.html" class="navigation navigation-next " aria-label="Next page: User and Group">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"User","level":"2.4","depth":1,"next":{"title":"User and Group","level":"2.4.1","depth":2,"path":"docker/user-and-group.md","ref":"docker/user-and-group.md","articles":[]},"previous":{"title":"Docker exec and Docker volume","level":"2.3.2","depth":2,"path":"docker/exec-and-volume.md","ref":"docker/exec-and-volume.md","articles":[]},"dir":"ltr"},"config":{"plugins":["github","disqus","-lunr","-search","search-plus","splitter","code","editlink","image-captions","back-to-top-button","page-toc-button","local-pagefooter","theme-default","favicon"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"k8s-notes"},"github":{"url":"https://github.com/zhiweiyin318"},"editlink":{"label":"Edit This Page","multilingual":false,"base":"https://github.com/zhiweiyin318/k8s-notes/blob/master/"},"splitter":{},"local-pagefooter":{"islocal":true,"modify_label":"Updated:","modify_format":"YYYY-MM-DD HH:mm:ss"},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"favicon":{"shortcut":"favicon.ico","bookmark":"favicon.ico"},"page-toc-button":{},"back-to-top-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"showLevel":true,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}},"search-plus":{},"image-captions":{"caption":"Image - _CAPTION_","variable_name":"_pictures"}},"theme":"default","author":"Zhiwei Yin","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"_pictures":[{"backlink":"content/concept.html#fig1.2.1","level":"1.2","list_caption":"Figure: IaaS-PaaS-SaaS","alt":"IaaS-PaaS-SaaS","nro":1,"url":"/images/IaaS-PaaS-SaaS.PNG","index":1,"caption_template":"Image - _CAPTION_","label":"IaaS-PaaS-SaaS","attributes":{},"skip":false,"key":"1.2.1"},{"backlink":"content/kubernetes.html#fig1.3.1","level":"1.3","list_caption":"Figure: Pod","alt":"Pod","nro":2,"url":"/images/kubernetes-pod.png","index":1,"caption_template":"Image - _CAPTION_","label":"Pod","attributes":{},"skip":false,"key":"1.3.1"},{"backlink":"kubernetes/deployment.html#fig3.3.2.1","level":"3.3.2","list_caption":"Figure: Kubernetes Deployment Yaml","alt":"Kubernetes Deployment Yaml","nro":3,"url":"/images/kubernetes-deployment-yaml.png","index":1,"caption_template":"Image - _CAPTION_","label":"Kubernetes Deployment Yaml","attributes":{},"skip":false,"key":"3.3.2.1"},{"backlink":"kubernetes/deployment.html#fig3.3.2.2","level":"3.3.2","list_caption":"Figure: Kubernetes Deployment ReplicaSet","alt":"Kubernetes Deployment ReplicaSet","nro":4,"url":"/images/kubernetes-deployment-rs.png","index":2,"caption_template":"Image - _CAPTION_","label":"Kubernetes Deployment ReplicaSet","attributes":{},"skip":false,"key":"3.3.2.2"},{"backlink":"kubernetes/deployment.html#fig3.3.2.3","level":"3.3.2","list_caption":"Figure: Kubernetes Deployment ReplicaSet","alt":"Kubernetes Deployment ReplicaSet","nro":5,"url":"/images/kubernetes-deployment-rs-2.png","index":3,"caption_template":"Image - _CAPTION_","label":"Kubernetes Deployment ReplicaSet","attributes":{},"skip":false,"key":"3.3.2.3"},{"backlink":"kubernetes/kubernetes-RBAC.html#fig3.4.5.1","level":"3.4.5","list_caption":"Figure: Kubernetes Access Control Overview","alt":"Kubernetes Access Control Overview","nro":6,"url":"/images/kubernetes-access-control-overview.PNG","index":1,"caption_template":"Image - _CAPTION_","label":"Kubernetes Access Control Overview","attributes":{},"skip":false,"key":"3.4.5.1"},{"backlink":"operator/declarative-api.html#fig4.1.1","level":"4.1","list_caption":"Figure: kubernetes api","alt":"kubernetes api","nro":7,"url":"/images/kubernetes-api.png","index":1,"caption_template":"Image - _CAPTION_","label":"kubernetes api","attributes":{},"skip":false,"key":"4.1.1"},{"backlink":"operator/declarative-api.html#fig4.1.2","level":"4.1","list_caption":"Figure: kubernetes api process","alt":"kubernetes api process","nro":8,"url":"/images/kubernetes-api-process.png","index":2,"caption_template":"Image - _CAPTION_","label":"kubernetes api process","attributes":{},"skip":false,"key":"4.1.2"},{"backlink":"operator/declarative-api.html#fig4.1.3","level":"4.1","list_caption":"Figure: kubernetes deployment yaml","alt":"kubernetes deployment yaml","nro":9,"url":"/images/kubernetes-deployment-yaml.png","index":3,"caption_template":"Image - _CAPTION_","label":"kubernetes deployment yaml","attributes":{},"skip":false,"key":"4.1.3"},{"backlink":"operator/declarative-api.html#fig4.1.4","level":"4.1","list_caption":"Figure: kubernetes custom controller","alt":"kubernetes custom controller","nro":10,"url":"/images/kubernetes-custom-controller.png","index":4,"caption_template":"Image - _CAPTION_","label":"kubernetes custom controller","attributes":{},"skip":false,"key":"4.1.4"},{"backlink":"operator/declarative-api.html#fig4.1.5","level":"4.1","list_caption":"Figure: kubernetes istio","alt":"kubernetes istio","nro":11,"url":"/images/kubernetes-istio-demo.jpg","index":5,"caption_template":"Image - _CAPTION_","label":"kubernetes istio","attributes":{},"skip":false,"key":"4.1.5"}]},"title":"Kubernetes Notes","language":"zh-hans","links":{"sidebar":{"My Blog":"https://zhiweiyin318.github.io/","Kubernetes-handbook(Jimmysong)":"https://jimmysong.io/kubernetes-handbook","Kubernetes":"https://kubernetes.io/"},"gitbook":true},"gitbook":"*","description":"Some notes about kubernetes during working and studying."},"file":{"path":"docker/user-in-docker.md","mtime":"2019-01-18T06:43:26.630Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-01-18T06:47:46.302Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

